
@using IA_AbansiBabayiSystemBlazor.Data.Models;
@using IA_AbansiBabayiSystemBlazor.Data;
@using IA_AbansiBabayiSystemBlazor.Services;
@using Microsoft.AspNetCore.Identity;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.EntityFrameworkCore

@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject TableDataService<TroopMember> TroopMemberService
@inject TableDataService<TroopLeader> TroopLeaderService
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext GetTroopMemberData
@inject SignInManager<ApplicationUser> SignInManager
@inject HttpClient Http
@inject AuthenticatorService AuthenticatorService
@inject IJSRuntime JS
@inject ILogger<UserPage> Logger

@page "/userPage"
@attribute [Authorize(Roles = "Admin, Troop Leader, Scout")]
@layout Layout.BlankLayout

<MudThemeProvider />
<MudPopoverProvider />
<!DOCTYPE html>

<div class="page-wrapper">

        <nav class="navigation">
            <div class="nav-bg">
                <div class="nav-left">
                    <img src="images/GIRL SCOUT LOGO.png" alt="Logo" class="nav-logo">
                    <div class="nav-links">
                        <a href="/userPage" class="nav-link">HOME</a>
                        <a href="#" class="nav-link">BADGES</a>
                        <a href="#" class="nav-link">TROOP<br>LOCATOR</a>
                    </div>
                </div>
                <p>@currentUserFname</p>
                <div class="nav-right">
                    <AuthorizeView Roles="Admin">
                    <a href="/managementPage" class="nav-link">ADMIN<br /> MANAGEMENT</a>
                    </AuthorizeView>
                    <AuthorizeView Roles="Troop Leader">
                        <a href="/scoutRegistrationRequestsPage" class="nav-link">TROOP LEADER<br/> MANAGEMENT</a>
                    </AuthorizeView>
                    <AuthorizeView Roles="Scout">
                        <a href="/scoutEventsAndAnnouncementPage" class="nav-link">EVENTS AND <br /> ANNOUNCEMENTS</a>
                    </AuthorizeView>
                    <MudMenu>
                        <ActivatorContent>
                            <MudAvatar Class="double-border">
                                <MudImage Src="images/default-scout-avatar.jpg" />
                            </MudAvatar>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem Href="/userProfilePage" Label="Profile" />
                            <MudDivider />
                            <MudMenuItem OnClick="LogoutAsync" Label="Logout" />
                        </ChildContent>
                    </MudMenu>
                </div>
            </div>
        </nav>

        <header class="hero">

            <img src="images/BG-Base1.png" alt="Background" class="hero-bg">
            
            <div class="hero-content">
                <div class="hero-text">
                    <h2 class="welcome-text">Welcome to,</h2>
                    <h1 class="main-title">
                        <span class="text-shadow">ILOILO<br>GIRL<br>SCOUT<br>COUNCIL</span>
                        <span class="gradient">ILOILO<br>GIRL<br>SCOUT<br>COUNCIL</span>
                    </h1>

                </div>
                <div>
                    <img src="images/BG-Vector.png" alt="Background" class="vector-image">
                </div>
            </div>
        </header>

        <section class="programs-grid">
            <article class="program-card camps">
                <h3 class="program-title">Camps</h3>
                <p class="program-description">
                    Camping provides adventures that prepare Girl Scouts for life. Camps
                    develop positive values, leadership, friendliness, and willingness to
                    serve.
                </p>
            </article>

            <article class="program-card program">
                <h3 class="program-title">Program</h3>
                <p class="program-description">
                    The GSP Program provides space for a girl to maximize her fullest
                    potential to become a responsible and productive member of society.
                </p>
            </article>

            <article class="program-card training">
                <h3 class="program-title">Training</h3>
                <p class="program-description">
                    Adult members receive opportunities to be trained and empowered as human
                    resource base for the Organization.
                </p>
            </article>

            <article class="program-card membership">
                <h3 class="program-title">Membership</h3>
                <p class="program-description">
                    Girls, young women, and adults who believe in Girl Scouting and accept
                    the principles embodied in the Girl Scout Promise and Law are welcome to
                    be members of GSP.
                </p>
            </article>
        </section>
        <div class="separator"></div>
        <div class="main-content">
            <div class="second-background"></div>
            <section class="news-section">
                <div class="news-content">
                    <div class="news-image-side-wrapper">
                        <div class="news-image-wrapper">
                            <img src="images/News1.jpg"
                                 alt="Group photo"
                                 class="news-image" />
                        </div>
                    </div>
                    <div class="news-text-side-wrapper">
                        <article class="news-text">
                            <h2 class="news-title">GSP Iloilo Council</h2>
                            <p class="news-description">
                                Earlier today, the museum was filled with these Twinklers, Stars,
                                Juniors, Seniors and Cadets of the Girl Scouts of the Philippines
                                -Iloilo Council. These Ilongga Scouts were able to gain knowledge of
                                the rich economic History of the country as well as appreciating
                                various historical and significant landmarks in the City.
                                This is in celebration of their 2nd Cultural Immersion and Traditional
                                Exposure (CITE) tour and the Museum and Galleries Month 2024.
                                Come and drop by the museum. We are just steps away from the Iloilo
                                City Hall. The Museum operates fro
                                This is in celebration of their 2nd Cultural Immersion and Traditional
                                Exposure (CITE) tour and the Museum and Galleries Month 2024.
                                Come and drop by the museum. We are just steps away from the Iloilo
                                City Hall. The Museum operates fro
                                Earlier today, the museum was filled with these Twinklers, Stars,
                                Juniors, Seniors and Cadets of the Girl Scouts of the Philippines
                                -Iloilo Council. These Ilongga Scouts were able to gain knowledge of
                                the rich economic History of the country as well as appreciating
                                various historical and significant landmarks in the City.
                                This is in celebration of their 2nd Cultural Immersion and Traditional
                                Exposure (CITE) tour and the Museum and Galleries Month 2024.
                                Come and drop by the museum. We are just steps away from the Iloilo
                                City Hall. The Museum operates fro
                                This is in celebration of their 2nd Cultural Immersion and Traditional
                                Exposure (CITE) tour and the Museum and Galleries Month 2024.
                                Come and drop by the museum. We are just steps away from the Iloilo
                                City Hall. The Museum operates fro
                                <br>
                                <br>
                            </p>
                            <a href="#" class="see-more">Read more...</a>
                        </article>
                    </div>
                </div>
            </section>
        </div>
        <footer class="footer">
            <p class="footer-text">Powered by <strong>ABANSIBABAYI</strong></p>
        </footer>
    </div>



@code {
    private ApplicationUser currentUser;
    private string currentUserFname;
    private string currentLeaderRole;
    private string currentTroopMemRole;
    private string errorMessage;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            // Use the service instead of writing the same code
            currentUser = await AuthenticatorService.GetCurrentUserAsync();

            if (currentUser == null)
            {
                NavigationManager.NavigateTo("/");
                return;
            }

            // Check if password reset is needed
            if (currentUser.MustChangePassword)
            {
                NavigationManager.NavigateTo("/forceResetPasswordPage", true);
                return;
            }

            // LOAD THE DATA FIRST before querying
            await TroopLeaderService.LoadDataAsync();
            await TroopMemberService.LoadDataAsync();

            // Now query the loaded data
            var troopLeaderAccount = TroopLeaderService.Data?
                .FirstOrDefault(t => t.ApplicationUserId == currentUser.Id);

            var troopMemberAccount = TroopMemberService.Data?
                .FirstOrDefault(t => t.ApplicationUserId == currentUser.Id);

            if (troopLeaderAccount != null)
            {
                currentUserFname = troopLeaderAccount.LeaderFname;

            }
            else if (troopMemberAccount != null)
            {

                currentUserFname = troopMemberAccount.TroopMemFname;

            }
            else
            {
                NavigationManager.NavigateTo("/");
                errorMessage = "User profile not found in troop data, but you can still reset your password.";
            }

        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading user data: {ex.Message}";
            Logger.LogError(ex, "Error in UserPage.OnInitializedAsync");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LogoutAsync()
    {
        await JS.InvokeVoidAsync("eval", @"
        fetch('/auth/logout', {
            method: 'POST',
            credentials: 'include'
        }).then(() => {
            window.location.href = '/landingPage';
        });
    ");
    }
}
   