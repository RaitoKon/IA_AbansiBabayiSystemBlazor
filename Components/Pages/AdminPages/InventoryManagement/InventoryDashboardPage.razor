@using IA_AbansiBabayiSystemBlazor.Data.Models
@using IA_AbansiBabayiSystemBlazor
@using Microsoft.AspNetCore.SignalR.Client
@using System.Globalization

@page "/inventoryDashboardPage"
@layout Layout.ThemedLayout
@attribute [Authorize(Roles = "Admin")]

@inject NavigationManager NavigationManager
@inject TableDataService<Transaction> TransactionService
@inject TableDataService<TransactionItem> TransactionItemService
@inject TableDataService<ProductStock> ProductStockService
@inject TableDataService<Product> ProductService
@inject IJSRuntime JS

<div class="hero-content">
    <MudPaper Class="pa-8 rounded-xl">
        <!-- Main flex container: green card + white card column -->
        <div style="display:flex; gap:1rem; align-items:stretch; flex-wrap:wrap;">

            <MudPaper
                      Style="
                          flex-grow: 1;
                          flex-shrink: 0;
                          border-radius: 25px;
                          background: linear-gradient(135deg, #28a745 0%, #85e085 100%);
                          color: white;
                          box-shadow: 0 10px 25px rgba(0,0,0,0.25);">

                <div style="padding-inline: 3rem; padding-top: 3rem;">
                    <div style="display: flex; align-items:center;">
                        <MudText Typo="Typo.h6" Style="font-weight: 200">Total Revenue</MudText>
                        <MudSpacer />
                        <MudTooltip Text="Total Revenue is the total income generated from all completed transactions before any expenses are deducted.">
                            <MudIconButton Icon="@Icons.Material.Filled.Info"
                                           Color="Color.Inherit"
                                           Size="Size.Small"
                                           Style="padding: 0;" />
                        </MudTooltip>
                    </div>

                    <MudText Typo="Typo.h3" Style="font-weight: 700" Class="ma-2">
                        ₱ @totalRevenue?.ToString("N2")
                    </MudText>
                    <MudText Typo="Typo.subtitle2" Style="font-weight: 200">
                        Current Month Revenue:
                        <b style="font-size:larger; font-weight: 700">
                            ₱ @currentMonthRevenue?.ToString("N2")
                        </b>
                    </MudText>

                    <MudItem Class="d-flex justify-space-between mt-3">
                        <MudItem Class="flex-column">
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 400;">Sales</MudText>
                            <MudText Typo="Typo.h3" Style="font-weight: 700;">@totalNoOfSales</MudText>
                        </MudItem>
                        <MudDivider Vertical="true" Style="height:60px; align-self:center;" />
                        <MudItem Class="flex-column">
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 400;">Returns</MudText>
                            <MudText Typo="Typo.h3" Style="font-weight: 700;">@totalNoOfReturn</MudText>
                        </MudItem>
                        <MudDivider Vertical="true" Style="height:60px; align-self:center;" />
                        <MudItem Class="flex-column">
                            <MudText Typo="Typo.subtitle2" Style="font-weight: 400; ">Damages</MudText>
                            <MudText Typo="Typo.h3" Style="font-weight: 700;">@totalNoOfDamage</MudText>
                        </MudItem>
                    </MudItem>
                </div>
                <div id="revenueAreaChart"></div>

            </MudPaper>

            <!-- White Card Column: stretches -->
            <div style="display:flex; flex-direction:column; gap:1rem; flex-grow: 5; flex-shrink: 1; min-width:250px;">

                <!-- Stock Overview Card -->
                <MudPaper Class="pa-6 rounded-xl"
                          Style="
                              background-color: white;
                              color: #333;
                              box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 500;">Stock Overview</MudText>
                        <MudTooltip Text="Overview of current stock levels for all products.">
                            <MudIconButton Icon="@Icons.Material.Filled.Info"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           Style="padding: 0;" />
                        </MudTooltip>
                    </div>
                    <MudItem Class="d-flex">
                        <MudItem>
                            <MudText Typo="Typo.h6" Style="font-weight: 700; margin-top: 0.5rem; text-wrap: nowrap;">Total Products</MudText>
                            <MudText Typo="Typo.subtitle2" Style="margin-top: 0.2rem; font-weight:400">In Stock</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Tertiary" Style =" font-weight:700">@totalNoOfInStock</MudText>
                            <MudText Typo="Typo.subtitle2" Style="margin-top: 0.2rem; font-weight:400">Low Stock</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Warning" Style="font-weight:700">@totalNoOfLowStock</MudText>
                            <MudText Typo="Typo.subtitle2" Style="margin-top: 0.2rem; font-weight:400">Out of Stock:</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error" Style="font-weight:700">@totalNoOfOutOfStock</MudText>
                            <MudText Typo="Typo.subtitle2" Style="margin-top: 0.2rem; font-weight:400">No Stock Entry:</MudText>
                            <MudText Typo="Typo.h6" Style="font-weight:700">@totalNoOfNoStockEntry</MudText>
                        </MudItem>
                        <div style="width: 100%; justify-items:center;">

                            <div id="stockDonutChart" style="width: 250px; height: 250px;"></div>

                        </div>
                    </MudItem>
                </MudPaper>

                <MudPaper Class="pa-6 rounded-xl"
                          Style="
              background-color: white;
              color: #333;
              box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <MudText Typo="Typo.subtitle2" Style="font-weight: 500;">Top Product Sale</MudText>
                        <MudTooltip Text="Top 3 best-selling products based on transaction count.">
                            <MudIconButton Icon="@Icons.Material.Filled.Info"
                                           Color="Color.Default"
                                           Size="Size.Small"
                                           Style="padding: 0;" />
                        </MudTooltip>
                    </div>

                    @if (topProductSales != null && topProductSales.Any())
                    {
                        @foreach (var item in topProductSales.Select((p, index) => new { p, index }))
                        {
                            <div style="margin-top: 0.8rem;">
                                <MudText Typo="Typo.subtitle2" Style="font-weight: 700;">
                                    @(item.index + 1). @item.p.ProductName
                                    —
                                    <MudText Typo="Typo.caption" Style="margin-top: 0.1rem; opacity: 0.7;">
                                        Total Sold: @item.p.TotalSold
                                    </MudText>
                                </MudText>
                            </div>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.subtitle2" Style="margin-top: 0.5rem; opacity: 0.7;">
                            No sales data available.
                        </MudText>
                    }
                </MudPaper>

            </div>

        </div>
    </MudPaper>
</div>

@code {

    private HubConnection? _hubConnection;

    private List<Transaction> Transactions = new();
    private List<ProductStock> ProductStocks = new();
    private List<Product> Products = new();

    private List<string> revenueMonthLabels = new();
    private List<double> revenueMonthValues = new();
    private List<double> salesRevenue = new();
    private List<double> returnRevenue = new();
    private List<double> damageRevenue = new();

    private List<(string? ProductName, int TotalSold)> topProductSales = new();

    private DateTime currentMonth = DateTime.Now;

    private decimal? totalRevenue;
    private decimal? currentMonthRevenue;
    private int? totalNoOfSales;
    private int? totalNoOfReturn;
    private int? totalNoOfDamage;
    private int? totalNoOfInStock;
    private int? totalNoOfLowStock;
    private int? totalNoOfOutOfStock;
    private int? totalNoOfNoStockEntry;

    protected override async Task OnInitializedAsync()
    {
        await LoadTransactions();

        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/autoUpdateHub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<string>("ReceiveUpdate", async (tableName) =>
        {
            if (tableName == nameof(Transaction))
            {
                await LoadTransactions(); // reload table when SignalR notifies
                StateHasChanged();
            }
        });

        await _hubConnection.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await OnInitializedAsync();
            await RenderDonutChart();
            await RenderRevenueLineChart();
        }
    }

    private async Task LoadTransactions()
    {
        await TransactionService.LoadDataAsync();
        Transactions = TransactionService.Data.ToList();

        await ProductStockService.LoadDataAsync();
        ProductStocks = ProductStockService.Data.ToList();

        await ProductService.LoadDataAsync();
        Products = ProductService.Data.ToList();

        totalRevenue = Transactions.Sum(t => t.TransactionTotalCost);
        currentMonthRevenue = Transactions
            .Where(t => t.TransactionDateAdded.HasValue &&
                        t.TransactionDateAdded.Value.Month == currentMonth.Month &&
                        t.TransactionDateAdded.Value.Year == currentMonth.Year)
            .Sum(t => t.TransactionTotalCost ?? 0);

        totalNoOfSales = Transactions.Count(t => t.TransactionType == "Sale");
        totalNoOfReturn = Transactions.Count(t => t.TransactionType == "Return");
        totalNoOfDamage = Transactions.Count(t => t.TransactionType == "Damage");

        totalNoOfInStock = ProductStocks.Count(p => p.StockMonthlyRemaining > 0);
        totalNoOfLowStock = ProductStocks.Count(p => p.StockMonthlyRemaining <= 50);
        totalNoOfOutOfStock = ProductStocks.Count(p => p.StockMonthlyRemaining == 0);
        totalNoOfNoStockEntry = Products.Count(p => !ProductStocks.Any(s => s.ProductId == p.ProductId));

        await TransactionItemService.LoadDataAsync();
        var transactionItems = TransactionItemService.Data.ToList();

        // Get all SALE transaction IDs
        var saleTransactionIds = Transactions
            .Where(t => t.TransactionType == "Sale")
            .Select(t => t.TransactionId)
            .ToList();

        // Compute top 3 best-selling products
        topProductSales = transactionItems
            .Where(ti => ti.TransactionId.HasValue &&
                         saleTransactionIds.Contains(ti.TransactionId.Value))
            .GroupBy(ti => ti.ProductId)
            .Select(g => new
            {
                ProductId = g.Key,
                TotalSold = g.Sum(x => x.ProductQuantity ?? 0) // int (not int?)
            })
            .OrderByDescending(x => x.TotalSold)
            .Take(3)
            .Join(
                Products,
                s => s.ProductId,
                p => p.ProductId,
                (s, p) => (p.ProductName, TotalSold: s.TotalSold) // ensure non-nullable here
            )
            .ToList();

        var monthlyRevenue = Transactions
            .Where(t => t.TransactionDateAdded.HasValue)
            .GroupBy(t => t.TransactionDateAdded.Value.Month)
            .OrderBy(g => g.Key)
            .ToDictionary(
                g => CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(g.Key),
                g => g.Sum(t => t.TransactionTotalCost ?? 0)
            );

        // Prepare monthly labels
        var monthlyGroups = Transactions
            .Where(t => t.TransactionDateAdded.HasValue)
            .GroupBy(t => t.TransactionDateAdded.Value.Month)
            .OrderBy(g => g.Key);

        revenueMonthLabels = monthlyGroups
        .Select(g => CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(g.Key))
        .ToList();


        // Prepare series per type
        salesRevenue = monthlyGroups
            .Select(g => g.Where(t => t.TransactionType == "Sale").Sum(t => (double)(t.TransactionTotalCost ?? 0)))
            .ToList();

        returnRevenue = monthlyGroups
            .Select(g => g.Where(t => t.TransactionType == "Return").Sum(t => (double)(t.TransactionTotalCost ?? 0)))
            .ToList();

        damageRevenue = monthlyGroups
            .Select(g => g.Where(t => t.TransactionType == "Damage").Sum(t => (double)(t.TransactionTotalCost ?? 0)))
            .ToList();

    }

    private async Task RenderDonutChart()
    {
        double[] donutData =
        {
        (double)(totalNoOfInStock ?? 0),
        (double)(totalNoOfLowStock ?? 0),
        (double)(totalNoOfOutOfStock ?? 0),
        (double)(totalNoOfNoStockEntry ?? 0)
        };

        string[] donutLabels = { "In Stock", "Low Stock", "Out of Stock", "No Stock Entry" };

        await JS.InvokeVoidAsync(
            "renderStockDonut",
            "stockDonutChart",
            donutData,
            donutLabels
        );
    }

    private async Task RenderRevenueLineChart()
    {
        await JS.InvokeVoidAsync(
            "renderAreaChart",
            "revenueAreaChart",
            new object[] { salesRevenue, returnRevenue, damageRevenue },
            revenueMonthLabels
        );
    }

}
